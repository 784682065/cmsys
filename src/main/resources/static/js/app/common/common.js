/** * 全局公共JS，及所有的接口请求 *//* inputType为页面上要验的格式类型：text:不为空，单选select：下拉单选,phone：手机号码，email：邮箱 card：身份证号码，日期不小于现在：nowdate，日期区间：anddate,一条条数据: checkTable; */var appToken = "";var inputType = "";var pageType = "";   //"":内跑，wp:外跑var listType = "";   //页面分为wait:待办、finish:已办、my:跟踪，add:发起申请var selectType = ""; //列表筛选类型var server = "/";    //根目录var indexUrl = "/appIndex"; //首页路径var listUrl = "/app/list";  //列表路径var userId = "";       //当前登录用户的IDvar userName = "";     //当前登录用户的姓名var userJob = "";      //当前登录用户的职务var userCard = "";     //当前登录用户的身份证var taskId = "";       //结束或驳回任务的时候需要用到var businessId = "";  //常见表单的关键IDvar processId = "";var tableType = "";     //不同表单类型的接口后缀var nodeId = "";        //a,b,c当前节点var msgListNull = 0;    //0:没有流转意见，1：有var opionsHtml = "";    //流转意见html串，（分为流转意见列表和当前输入意见）var mustGiveMsg = "";   //是否必须给意见才能审核,true:必须，false可不填var reloadFinish = 0;   //0：正在刷新列表，1：刷新完毕可以进行下次刷新var pageNumber = 1;     //列表页码var pageSize = 15;      //列表每页条数var totalNum = 0;       //列表请求到的总条数var listDataType = 0;  //0：正常列表数据加载及刷新，1：加载更多条数据var listTitle = "";    //列表中文名称 待办、已办、跟踪事项var listBack = 0;       //0:首页进入列表，1：从详情进入列表var needUserInfo;      //0：不需要，1：需要,有些表单不需要当前用户信息如会议审批var needUserSex;       //表单中是否用到当前登录用户的性别信息var saveDataYes = 0;      // 业务数据是否保存完毕，业务数据只保存一次，发起流程是判断var submitType="";        // 审核意见1：同意，2：驳回var saveMsged = 0;         //0：未保存，1：已保存var msgNameTitle = "";    //获取到的当前意见区的名称数据var dataGetCount = 0;      //每个页面的第一个接口的获取次数，2次以后报错，第一次报错可能是需要登录var saveType = "normal";  //normal:正常resave:重新提交，页面展示的时候需要将内容填充进input中var instanceId = "";      //结束流程是用这个ID，待办列表可以获取到var saveDataResult = "";  //业务数据保存有时候有返回VARIABLES这个参数，需要在开启流程的时候带过去var isLoginStatus = 0;var addOrView = "";        //表单添加或查看 add,viewvar prodict = "";          //0：不预审核，1：需要预审核,只有外跑的业务可能需要预审核var receiveType = "";     //1:需要领取，""：不需要领取，view：预览，edit:领取var conclusionifr = "";   //管制刀具和仿真枪用 认定报告结论 "":不用理会，0：隐藏、1：只读 ，2.可填写var gunPreifr = "";       //认定报告编号和初次认定部门... 同上var gunDeptifr = "";      //初次认定部门 同上var gunNumifr = "";       //认定报告编号 同上var isGiveOther="0";     //1：需要流转给他人。0：不需要var isLast = "1";         //是否是流程末节点var single;               //各页面的独立业务处理var commons = {    logIn: function () {  //登陆        $.ajax({            url: server + "appLogin?app=Y",            type: "post",            dataType: "text",            async: false,            data: {"username": userId},            success: function (data) {                $(".loadModal").hide();                $(".home").show();                isLoginStatus = 1;            }, error: function (data) {                commons.alertMsg("网络错误");            }        });    },    logOut: function () { //登出        $.ajax({            url: server + "appLogout?app=Y",            type: "get",            async: false,            success: function (data) {            }, error: function (data) {            }        });    },    alertMsg: function (str) {  //展示：信息提示弹窗        $("#msgText").text(str);        $(".dialog").fadeIn(300);        setTimeout(function () {            $(".dialog").fadeOut(300);        }, 1200);    },    errorToIndex: function (data) {        if (data.code == "1001") {            location.href = indexUrl;        }    },    pageVal: function () {        if (getCookie("userId") && getCookie("userId") != "") {            userId = getCookie("userId");        } else {            location.href = indexUrl;        }    },    receiveTask: function (taskid) {   //待办列表认领任务        $.ajax({            url: server + "OA/claimTask?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"TASKID": taskid},            success: function (data) {                if (data.rtnCode == "2000") {                    commons.alertMsg("认领成功");                    setTimeout(function () {                        location.href = tableType + "?app=Y";                    }, 1200);                } else {                    commons.alertMsg("认领失败");                }            }, error: function (data) {                commons.errorToIndex(data);                commons.alertMsg("认领失败");            }        });    },    getMainData: function () {  //获取业务主键及流程ID        $.ajax({            url: server + tableType + "/seq?app=Y",            type: "post",            dataType: "json",            async: false,            success: function (data) {                if (data.rtnCode == "2000") {                    processId = data.process;                    userId = data.promoter;                    if (saveType == "normal") {                        businessId = data.business;                    }                    $(".addBtn").click(function () {                        setTimeout(function () {                            NativeApi.getImage(processId, businessId); //调用原生图库或摄像头                        }, 1000);                    });                } else {                    commons.alertMsg("数据获取失败");                }            }, error: function (data) {                commons.errorToIndex(data);                commons.alertMsg("服务器错误");            }        });    },    getPosterInfo: function () {  //获取当前用户的基本信息        $.ajax({            url: server + "abroad/getInfo?app=Y", // tableType +这个接口应该是公共的不应该使用abroad后缀            type: "post",            dataType: "json",            async: false,            success: function (data) {                userName = data.name;                userJob = data.duty;                userCard = data.id;                if(needUserSex==1) {                    if (data.sex && data.sex == "01") {                        $("#man").attr("checked", "checked");                        $("#woman").removeAttr("checked").attr("disabled", "disabled");                    } else {                        $("#woman").attr("checked", "checked");                        $("#man").removeAttr("checked").attr("disabled", "disabled");                    }                }                commons.userInfoShow();            }, error: function (data) {                commons.errorToIndex(data);                commons.alertMsg("用户信息获取失败");            }        });    },    userInfoShow: function () {        $("#userName").text(userName);        $("#userCard").text(userCard);        if(tableType == "repairs") {            $("#userJob").text(userJob);        }else{            $("#userJob").val(userJob);        }    },    getDataInfo: function () {   //获取内跑表单业务数据，        $.ajax({            url: server + tableType + "/read?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"business": businessId},            success: function (data) {                if (data && data != "") {                    if (saveType == "resave") {                        single.resaveNps(data);   //内跑驳回后再次查看去重新保存的页面                    } else {                        single.npsView(data);     //内跑帧正常查看或审核页面表单渲染                    }                }            }, error: function (data) {                commons.errorToIndex(data);                commons.alertMsg("获取业务数据失败");            }        });    },    getWpContent: function () {   //外跑业务数据获取           $.ajax({            url: server + tableType + "/init?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"business": businessId},            success: function (data) {                if (data&&data != "") {                    $("#views").show();                    single.wpView(data);   //外跑页面表单渲染                } else {                    commons.alertMsg("业务数据获取失败");                }            }, error: function (data) {                commons.errorToIndex(data);                commons.alertMsg("业务数据获取失败");            }        });    },    getInitTask: function () {   //后续审核人员查看页面或完成审核时必须先调用此接口        $.ajax({            url: server + "OA/init?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"taskId": taskId},   //接口文档写错了大小写            success: function (data) {            }, error: function (data) {                commons.errorToIndex(data);            }        });    },    endProcess: function () { //结束表单流程，用户看到之前的申请单被驳回后选择取消申请        $.ajax({            url: server + "OA/endProcess?app=Y",            type: "post",            dataType: "json",            async: false,            //参数 PROMOTER为发起人userID, PROCESSID为表单ID，BUSINESSID为业务主键及流程接口获取到的            data: {"PROCESSINSTANCEID": instanceId},            success: function (data) {                if (data.rtnCode == "2000") {                    commons.alertMsg("作废成功");                    setTimeout(function () {                        location.href = listUrl;                    }, 1800);                } else {                    commons.alertMsg("作废失败");                    setTimeout(function () {                        location.href = listUrl;                    }, 1800);                }            }, error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg("作废失败");                }, 1800);            }        });    },    startProcess: function (str) { //启动流程，表单业务数据保存后，启动流程意味着将开始流转        var datas;        if (str == "") {            //参数 PROMOTER为发起人userID, PROCESSID为表单ID，BUSINESSID为业务主键及流程接口获取到的            datas = {"PROMOTER": userId, "PROCESSID": processId, "BUSINESSID": businessId};        } else {            datas = {                "PROMOTER": userId,                "PROCESSID": processId,                "BUSINESSID": businessId,                "VARIABLES": saveDataResult            };        }        $.ajax({            url: server + "OA/startFlow?app=Y",            type: "post",            dataType: "json",            async: false,            data: datas,            success: function (data) {                if (data.rtnCode == "2000") {                    setTimeout(function () {                        commons.alertMsg("提交成功");                    }, 1800);                } else {                    setTimeout(function () {                        commons.alertMsg(data.errorMessage);                        location.href = indexUrl;                    }, 1600);                }                setTimeout(function () {                    var backType = $(".back").attr("data");                    if (backType == "detail") {                        location.href = listUrl;                    } else if (backType == "list" || backType == "add") {                        location.href = indexUrl;                    }                }, 2000);            }, error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    saveData: function (datas) {  //保存业务数据        var saveurl = "";        if (saveType == "normal") {            saveurl = server + tableType + "/save?app=Y";        } else if (saveType == "resave") {            saveurl = server + tableType + "/update?app=Y";        }        //姓名 请假日期起 请假日期止 费用是否自理 去往城市 所在单位及职务 身份证号码 理由 随行人员 性别 业务主键        $.ajax({            url: saveurl,            type: "post",            dataType: "json",            async: false,            data: datas,            success: function (data) {                if (data.rtnCode == "2000") {                    saveDataYes = 1;                    var str = "";                    if (data.VARIABLES && data.VARIABLES != "") {                        str = data.VARIABLES;                        str = formats.strToJson(str);                        saveDataResult = '{"path":"' + str.path + '"}';                    } else {                        saveDataResult = "";                    }                    if (saveType == "normal") {                        commons.startProcess(saveDataResult);                    } else if (saveType == "resave") {                        commons.finished();                    }                } else {                    commons.alertMsg(data.errorMessage);                    $(".locked").fadeOut();                }            }, error: function (data) {                $(".locked").fadeOut();                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    toPersons:function(PERSONS){        $.ajax({            url: server + "OA/getAuthority?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"PERSONS": PERSONS,"PROCESSINSTANCEID":instanceId},   //这个taskid是大写            success: function (data) {                commons.finishedApi();            },error:function(data){                commons.alertMsg("流转给他人处理失败");                $(".locked").fadeOut();            }        });    },    finishedApi:function(){        $.ajax({            url: server + "OA/complete?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"TASKID": taskId},            success: function (data) {                if (data.rtnCode == "2000") {                    setTimeout(function () {                        commons.alertMsg("提交成功");                    }, 1600);                } else {                    commons.alertMsg(data.errorMessage);                }                setTimeout(function () {                    location.href = listUrl;                }, 2000);            }, error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    finished: function () {  //同意申请        if(isGiveOther=="0") {            commons.finishedApi();        }else{            $(".main,.footer").hide();            $(".contacts").show();            contacts.init();        }    },    reject: function () {  //驳回申请        $.ajax({            url: server + "OA/rollback?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"TASKID": taskId},            success: function (data) {                if (data.rtnCode == "2000") {                    setTimeout(function () {                        commons.alertMsg("提交成功");                    }, 1600);                } else {                    setTimeout(function () {                        commons.alertMsg(data.errorMessage);                    }, 1600);                }                setTimeout(function () {                    location.href = listUrl;                }, 2000);            }, error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    getFileList: function () { //获取附件列表        $.ajax({            url: server + "file/list?app=Y",            type: "post",            async: false,            data: {"businessId": businessId},            success: function (data) {                if (data && data != "") {                    commons.fileListShow(data);                }            },            error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    fileUp: function () {  //附件上传接口        var form = new FormData(document.getElementById("fileForm"));        $.ajax({            url: server + "file/upload?app=Y",            type: "post",            data: form,            processData: false,            contentType: false,            async: false,            success: function (data) {                $("#fileInput").val("");                var value = data.list;                if (data.list && data.list != "") {                    commons.nowFileShow(data.list);                }            },            error: function (data) {                $("#fileInput").val("");                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    fileSave: function (fileid) {        $.ajax({            url: server + "file/save?app=Y",            type: "post",            async: false,            data: {"business": businessId, "process": processId, "fileid": fileid},            success: function (data) {                $(".fileModal,.modalBg").fadeOut(200);                setTimeout(function () {                    commons.alertMsg("附件保存成功");                    $(".fileModalList").html("");                }, 200);                setTimeout(function () {                    commons.getFileList();                }, 1500);            },            error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    fileDown: function (id, text, url) { //附件下载        $.ajax({            url: server + "file/download?app=Y",            type: "post",            async: false,            data: {"fileid": id, "filename": text, "fileurl": url},            success: function (data) {                if (data && data != "") {                    var type = "";                    var img = data.split('"')[1];                    if (text.split(".")[1].indexOf("png") > -1) {                        type = "images";                        img = "data:image/png;base64," + img;                    } else if (text.split(".")[1].indexOf("jpg") > -1) {                        type = "images";                        img = "data:image/jpg;base64," + img;                    } else if (text.split(".")[1].indexOf("gif") > -1) {                        type = "images";                        img = "data:image/gif;base64," + img;                    } else {                        type = "files";                        commons.alertMsg("文件类型需要原生支持");                    }                    if (type == "images") {                        $(".alertImg").html('<img src="' + img + '"><div>' + data + '</div>');                    }                }            },            error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    fileDel: function (id, dom, url) {  //附件删除        $.ajax({            url: server + "file/delete?app=Y",            type: "post",            async: false,            data: {"fileid": id, "business": businessId, "process": processId, "fileurl": url},            success: function (data) {                if (data.rtnCode && data.rtnCode == "2000" && url != "") {                    commons.alertMsg("删除成功");                }                dom.hide().remove();            },            error: function (data) {                commons.errorToIndex(data);                commons.alertMsg("删除失败");            }        });    },    getRightBtn: function () { //权限及按钮组        $.ajax({            url: server + "OA/getAuthority?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"TASKID": taskId},   //这个taskid是大写            success: function (data) {                //以下例子Hide可能是Read、write、ReadAndWrite                //该组件判断是否是重新提交：{"authority":[{"component":"lock"}],"rtnCode":"2000"}                //隐藏填写意见：{"authority":[{"component":"opinion","authority":"Hide"}                //隐藏驳回按钮：{"component":"oarollback","authority":"Hide"}],"rtnCode":"2000"}                //隐藏认定报告书编号和认定部门：{"component":"preifr","authority":"Hide"}],"rtnCode":"2000"}                //隐藏认定报告书编号：{"component":"numifr","authority":"Hide"}],"rtnCode":"2000"}                //隐藏初次认定部门：{"component":"deptifr","authority":"Hide"}],"rtnCode":"2000"}                //隐藏认定结论：{"component":"conclusionifr","authority":"Hide"}],"rtnCode":"2000"}                //正常两个按钮"component":"end"                //预审的表单如果权限中存在pick,则需要流转给其他人：{"component":"pick"}                //"":不用理会，0：隐藏、1：只读 ，2.可读写  conclusionifr,gunPreifr, gunDeptifr,gunNumifr="",mustGiveMsg                if (prodict == "0") { //不需要预审核                    if (data.authority && data.authority != "") {                        $(data.authority).each(function (i, d) {                            if (d.component && d.component == "lock") {                                saveType = "resave";                                if (msgListNull == 0) {                                    $(".myIdea").parent().hide().remove();                                }else {                                    $(".myIdea").hide().remove();                                }                                $("#approval").text("重新提交");                                $("#reject").text("作废");                            } else if (d.component && d.authority && d.component == "opinion" && d.authority == "Hide") {                                if (msgListNull == 0) {                                    $(".myIdea").parent().hide().remove();                                }else {                                    $(".myIdea").hide().remove();                                }                                mustGiveMsg = "remove";                            } else if (d.component && d.authority && d.component == "oarollback" && d.authority == "Hide") {                                $("#approval").addClass("big");                                $("#reject").hide().remove();                            } else if (d.component && d.authority && d.component == "preifr") {                                if (d.authority == "Hide") {                                    $(".preifr").hide();                                    gunPreifr = "0";                                } else if (d.authority == "Read") {                                    gunPreifr = "1";                                    $(".preifr").show();                                } else if (d.authority == "ReadAndWrite") {                                    gunPreifr = "2";                                    $(".preifr").show();                                }                            } else if (d.component && d.authority && d.component == "numifr") {                                if (d.authority == "Hide") {                                    gunNumifr = "0";                                    $(".numifr").hide().remove();                                } else if (d.authority == "Read") {                                    gunNumifr = "1";                                    $(".preifr,.numifr").show();                                } else if (d.authority == "ReadAndWrite") {                                    gunNumifr = "2";                                    $(".preifr,.numifr").show();                                }                            } else if (d.component && d.authority && d.component == "deptifr") {                                if (d.authority == "Hide") {                                    gunDeptifr = "0";                                    $(".numifr").hide().remove();                                } else if (d.authority == "Read") {                                    gunDeptifr = "1";                                    $(".preifr,.deptifr").show();                                } else if (d.authority == "ReadAndWrite") {                                    gunDeptifr = "2";                                    $(".preifr,.deptifr").show();                                }                            } else if (d.component && d.authority && d.component == "conclusionifr") {                                if (d.authority == "Hide") {                                    $(".conclusion").hide();                                    conclusionifr = "0";                                } else if (d.authority == "Read") {                                    conclusionifr = "1";                                    $(".preifr,.conclusion").show();                                } else if (d.authority == "ReadAndWrite") {                                    conclusionifr = "2";                                    $(".preifr,.conclusion").show();                                }                            } else if (d.component && d.authority && d.component == "approve" && d.authority == "ReadAndWrite") {                                $("#approval").addClass("big");                                $("#reject").hide().remove();                            } else if (d.component && d.authority && d.component == "end" && d.authority == "ReadAndWrite") {                                isLast = "1";                            }                        });                    }                } else if (prodict == "1") { //预审核                    if (data.authority && data.authority != "") {                        $(data.authority).each(function (i, d) {                            if (d.component && d.component == "pick") {                                isGiveOther="1";                            }                        });                    }                    $("#approval").text("审核通过");                    $("#reject").text("审核不通过");                }                $("#subForm").hide().remove();                $(".footer").show();            }, error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    saveConclusion: function () {  //保存结论-管制刀具和仿真枪        var conclusVal = $("#conclusion").val();        var deptVal = $("#deptifr").val();        var numifrVal = $("#numifr").val();        if (conclusVal && deptVal && numifrVal && conclusVal != "" && deptVal != "" && conclusVal != "") {            $.ajax({                url: server + tableType + "/saveConclusion?app=Y",                type: "post",                dataType: "json",                async: false,                data: {"business": businessId, "conclusion": conclusVal, "preDept": deptVal, "preNum": numifrVal}, //conclusion:结论,preDept:部门,preNum:报告编号                success: function (data) {                    if (submitType == "1" || pageType == "wp") {                        commons.finished();                    } else if (submitType == "2") {                        commons.reject();                    }                }, error: function (data) {                    $(".locked").fadeOut();                    commons.alertMsg("认定结论保存失败");                }            });        } else {            if (conclusVal == "" || conclusVal == undefined || conclusVal == "null") {                $(".conclusion").addClass("red");            } else if (deptVal == "" || deptVal == undefined || deptVal == "null") {                $(".deptifr").addClass("red");            } else if (numifrVal == "" || numifrVal == undefined || numifrVal == "null") {                $(".numifr").addClass("red");            }            commons.alertMsg("请完整填写表单");            $(".locked").fadeOut();        }    },    getMustMsg: function () {   //查询当前人员是否必须填写意见，驳回反复审批可不填写        $.ajax({            url: server + tableType + "/isWrite?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"business": businessId, "node": nodeId},            success: function (data) {                if (data) {                    if (mustGiveMsg == "remove") {                        mustGiveMsg = false;                    } else {                        mustGiveMsg = data;                    }                }                //data为 true 需要审核意见，false不需要            }, error: function (data) {                if(mustGiveMsg == "remove") {                    mustGiveMsg = false;                } else {                    mustGiveMsg = true;                }                commons.errorToIndex(data);            }        });    },    getMsgName: function () { //获取当前用户的意见区名称        $.ajax({            url: server + tableType + "/title?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"nodeName": nodeId},            success: function (data) {                if (data.rtnCode == "2000") {                    msgNameTitle = data.title;                }            }, error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },    saveMsg: function () {  //保存审批的意见内容        var datas;        if (pageType == "np") {            datas = {                "business": businessId,                "type": submitType,                "title": msgNameTitle,                "node": nodeId,                "opinion": $("#ideaText").val(),                "instance":instanceId            };        } else if (pageType == "wp") {            datas = {                "business": businessId,                "type": submitType,                "title": msgNameTitle,                "node": nodeId,                "opinion": $("#ideaText").val(),                "issync": 'N'            };        }        $.ajax({            url: server + tableType + "/opinion?app=Y",            type: "post",            dataType: "json",            async: false,            data: datas,            success: function (data) {                if (data.rtnCode == "2000") {                    saveMsged = 1;                    if (submitType == 1 || pageType == "wp") { //内跑审核通过、外跑事项审核通过和不通过                        commons.finished();                    } else {    //内跑驳回                        commons.reject();                    }                } else {                    setTimeout(function () {                        commons.alertMsg(data.errorMessage);                        $(".locked").fadeOut();                    }, 1600);                }            }, error: function (data) {                commons.errorToIndex(data);                commons.alertMsg(data.errorMessage)            }        });    },    getMeetName:function(){        $.ajax({            url: server + "meeting/getInfo?app=Y",            type: "post",            dataType: "json",            async: false,            success: function (data) {                var value;                var itemHtml="";                if(data&&data!=""){                    if(data.initName&&data.initName!=""){                        value = data.initName;                        $(value).each(function(i,d){                            itemHtml+='<option value="'+ d.id+'">'+ d.text+'</option>'                        });                    }                }                $("#meetingNames").html('<option value="">请选择会议名称</option>'+itemHtml).show();            }, error: function (data) {            }        });    },    getMsgList: function () {  //获取已审核的意见列表        $.ajax({            url: server + tableType + "/opinionList?app=Y",            type: "post",            dataType: "json",            async: false,            data: {"business": businessId},            success: function (data) {                var value = data.opinion;                if (value && value != "" && data.rtnCode == "2000") {                    var ideaHtml = "";                    $(value).each(function (i, d) {                        var msgtext = '';                        if (pageType == "np" && d.OPINION) {                            msgtext = d.OPINION;                        } else if (pageType == "wp" && d.OPINIONTEXT) {                            msgtext = d.OPINIONTEXT;                        }                        ideaHtml += '<div class="item idea">' +                        '<label>' + d.OPINIONTITLE + '</label><div class="text">' +                        '<div class="opinType">' + d.OPINIONTYPE + '</div><span>' + msgtext + '</span></div>' +                        '<div class="write"><span>签字：</span><span>' + d.USERNAME + '</span></div>' +                        '<div class="date"><span>' + d.OPINIONDATE + '</span></div></div>';                    });                    if (ideaHtml != "") {                        msgListNull = 1;                        opionsHtml = '<div class="block"><h3>各级领导意见</h3>' + ideaHtml;                    } else {                        opionsHtml="";                        msgListNull = 0;                    }                } else {                    msgListNull = 0;                }                if (listType == "wait") {                    commons.write();                } else{                    $("#write").html(opionsHtml);                }            }, error: function (data) {                commons.errorToIndex(data);                setTimeout(function () {                    commons.alertMsg(data.errorMessage);                }, 1600);            }        });    },write: function () {  //待办进去的意见区渲染        var itemHtml = '<div class="item idea myIdea">' +            '<label>' + msgNameTitle + '</label>' +            '<textarea class="ideaText" id="ideaText" placeholder="审核意见"></textarea>' +            '<div class="quick"><div class="quickClick"><img src="/static/img/app/quick.png">' +            '</div></div><select class="quickIdea">' +            '<option>同意</option><option>批准</option><option>驳回</option><option>审核通过</option></select></div>';        if (msgListNull == 1) {            itemHtml = opionsHtml + itemHtml + '</div>';        } else if (msgListNull == 0) {            itemHtml = '<div class="block"><h3>各级领导意见</h3>' + itemHtml + '</div>';        }        $("#write").html(itemHtml);    },    nowFileShow: function (data) { //上传的附件临时列表展示        var itemHtml="";        $(data).each(function (i, d) {            itemHtml += '<div class="item nowFile" data-text="' + d.text + '" data-field="' + d.id + '">' +            '<img src="/static/img/app/file.png">' +            '<span class="name">' + d.text + '</span>' +            '<span class="del"></span></div>';        });        if (itemHtml != "") {            $(".fileModalList").append(itemHtml);        }        $(".fileModalList").on("click", ".del", function () {  //临时上传的文件删除，不加入保存            var dom = $(this).parent();            var nowid = dom.data("field");            commons.fileDel(nowid, dom, "");        });    },    fileListShow: function (data) {  //附件保存后页面列表展示        var itemHtml = "";        if (saveType == "resave" || listType == "add") {  //发起和重新提交的时候可以删除附件            $(data).each(function (i, d) {                itemHtml += '<div class="fileItem" data-url="' + d.FILEURL + '" data-id="' + d.FILEID + '" data-name="' + d.FILENAME + '">' +                '<img src="/static/img/app/file.png">' +                '<span class="name filedown">' + d.FILENAME + '</span><span class="del"></span>' +                '<span class="desText filedown">' + d.OWNER + '&nbsp;&nbsp;' + d.INS_DATE + '</span>' +                '</div>';            });        } else {            $(data).each(function (i, d) {                itemHtml += '<div class="fileItem" data-url="' + d.FILEURL + '" data-id="' + d.FILEID + '" data-name="' + d.FILENAME + '">' +                '<img src="/static/img/app/file.png">' +                '<span class="name filedown">' + d.FILENAME + '</span>' +                '<span class="desText filedown">' + d.OWNER + '&nbsp;&nbsp;' + d.INS_DATE + '</span>' +                '</div>';            });        }        if (itemHtml != "") {            if(saveType == "resave") {                itemHtml = '<div class="block"><h3>附件</h3>' +                '<div class="item"><label>备注</label><p>有相关材料，请一并附件上传</p></div>' +                '<div class="item"><label>附件上传</label><p>' +                '<button type="button" class="smallBtn" id="fileModalBtn">' +                '<img src="/static/img/app/up2.png"><span>附件上传</span></button></p></div>' +                '<div class="item">'+itemHtml+'</div></div>';            }else{                itemHtml = '<div class="block"><h3>附件</h3><div class="item">' + itemHtml + '</div></div>';            }            $(".pageFiles").html(itemHtml);            if (listType == "add") {                $('html, body').animate({                    scrollTop: $(".pageFiles").offset().top + 200                }, 1000);            }        }        $(".pageFiles").on("click", ".del", function () {  //临时上传的文件删除，不加入保存            var dom = $(this).parent();            var nowid = dom.data("id");            var name = dom.data("name");            var url = dom.data("url");            commons.fileDel(nowid, dom, url);        });    },    pageStyle: function () {  //页面样式相关        if(saveType=="normal") { //日期样式移动端美化，可考虑后续手工html加上class            $("input[type='date']").each(function(){                if($(this).attr("id")!="startoff"){                    $(this).parent().addClass("dateBg");                }            });        }    },    bind: function () {  // 通用元素事件绑定        var that = this;        //小标题点击将下面的内容显示隐藏        $(".main").on("click", "h3", function () {            if ($(this).data("status") == "close") {                $(this).data("status", "open").removeClass("off").parent().find(".item").fadeIn();            } else {                $(this).data("status", "close").addClass("off").parent().find(".item").fadeOut();            }        });        $("table").each(function () { //表格批量加class，以满足横向滚动，后续可考虑写死在html            if ($(this).data("type") != "normal") {                if ($(this).parent().attr("class").indexOf("item") > -1) {                    $(this).parent().addClass('tables');                }            }        });        $(".back").click(function () {  // 返回按钮            var backType = $(this).attr("data");            if (backType == "detail") {                location.href = listUrl;            } else if (backType == "list" || backType == "add") {                location.href = indexUrl;            }        });        //附件准备上传按钮点击        $("#fileModalBtn").click(function () {            $(".fileModal,.modalBg").show();            $(".fileModalList").html("");        });        //附件保存按钮        $("#fileSaveSub").click(function () {            var that = this;            var fileData = [];            $(".nowFile").each(function (i, d) {                fileData.push({"FILEID": $(this).data("field"), "FILENAME": $(this).data("text"), "xh": i});            });            var datas = JSON.stringify(fileData);            if (datas != "[]") {                commons.fileSave(datas);            } else {                commons.alertMsg("请先上传附件");            }        });        //取消保存上传的附件按钮        $("#fileCancel").click(function () {            $(".fileModal,.modalBg").fadeOut(400);            setTimeout(function () {                $(".fileModalList").html("");            }, 500);        });        //附件点击查看事件        $(".pageFiles").on("click", ".filedown", function () {            var fid = $(this).parent().data("id");            var fname = $(this).parent().data("name");            var furl = $(this).parent().data("url");            if (fid && fname && furl && fid != "" && fname != "" && furl != "") {                NativeApi.openFileByOther(fid, fname, furl);            } else {                commons.alertMsg("附件参数缺失");            }        });        $("#write").on("change", ".quickIdea", function () {  //快速回复选择事件            if ($(this).val() != "") {                $(this).prev().prev().addClass("active").val($(this).val());            } else {                $(this).prev().prev().removeClass("active").val($(this).val());            }        }).on("change", ".ideaText", function () {            if ($(this).val() != "") {                $(this).addClass("active");            } else {                $(this).removeClass("active");            }        }).on("focus", ".ideaText", function () {            if ($(this).val() != "") {                $(this).addClass("active");            } else {                $(this).removeClass("active");            }        });        $(".block").on("change", "input,textarea", function () {  //常见输入框输入后将之前的格式不正确提示取消            $(this).parent().parent().removeClass("red");        }).blur(function () {            if ($(this).val() != "") {                $(this).parent().parent().removeClass("red");            }        });    }};/* *  其他公共方法 *///cookie获取function getCookie(c_name) {    if (document.cookie.length > 0) {        c_start = document.cookie.indexOf(c_name + "=");        if (c_start != -1) {            c_start = c_start + c_name.length + 1;            c_end = document.cookie.indexOf(";", c_start);            if (c_end == -1) c_end = document.cookie.length;            return unescape(document.cookie.substring(c_start, c_end));        }    }    return "";}//设置cookiefunction setCookie(c_name, value, expiredays) {    var exdate = new Date();    exdate.setTime(exdate.getTime() + 60 * 10000000 * expiredays);    //exdate.setDate(exdate.getDate() + expiredays);    document.cookie = c_name + "=" + escape(value) + ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString() + ";path=/");}/** * 和原生交互的方法 *///原生上传成功后,直接调用此方法,将后台返回的json数据传参给data，传过来即可function getAppImages(data) {    //commons.alertMsg(data);    if (data.rtnCode == "2000" && data.list) {        commons.nowFileShow(data.list);    } else {        commons.alertMsg("附件上传失败");    }}//调用原生NativeApi.getAPPToken()获取token成功后,原生调用此方法将token回传过来function getAppToken(appToken, policeStore) {    setTimeout(function () {        //commons.alertMsg("获取到的token："+appToken);        userId = "330203197005110312";        setCookie("userId", "330203197005110312", "1");        setCookie("appToken", appToken, "1");        homes.bind();        commons.logIn();        homes.getAllRight();    }, 2000);}