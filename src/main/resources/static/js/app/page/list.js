/** * 待办、已办、跟踪事项列表相关JS */var lists = {    init: function () {        var that = this;        listDataType = 0;        this.bind();        this.getListType();    },    getListType: function () {  //待办已办使用的是同一个模板页面，从url的type中区分        listType = getCookie("listType");        userId = getCookie("userId");        setCookie("receiveType","","1"); //领取        if(getCookie("selectType")&&getCookie("selectType")!=""){            selectType = getCookie("selectType");        }else{            selectType = "";        }        var listStr = getCookie("listBack");        if (listStr) {            listBack = listStr;        }        lists.listName();        lists.getListData();        $("#listTitle").text(listTitle);        document.title = listTitle;        if(selectType!="") {            $("#listTitle").text(listTitle + '（' + $("#" + selectType).text() + '）');        }    },    listName: function () {  //返回列表中文标题        if (listType == "wait") {            listTitle = "待办";        } else if (listType == "finish") {            listTitle = "已办";        } else if (listType == "my") {            listTitle = "跟踪事项";        }    },    listView: function (data) { //列表数据组装渲染        var value = data.rows;        var itemHtml = [];        if (totalNum == 0 && pageNumber == 1) {            itemHtml.push('<div class="listNullMsg">没有任务了</div>');        } else if (totalNum == 0 && pageNumber != 1) {            itemHtml.push('<div class="listNullMsg">没有更多任务了</div>');        }        if (totalNum != 0) {            if (listType == "wait") {                $(value).each(function (i, d) {                    var assing = "";                    if (d.ASSIGNEE_ == undefined || d.ASSIGNEE_ == "" || d.ASSIGNEE_ == null || d.ASSIGNEE_ == "null") {                        assing = "";                    } else {                        assing = d.ASSIGNEE_;                    }                    itemHtml.push('<div class="list-item no-right" data-id="' + d.BUSINESS_ID_ + '" data-assing="' + assing + '"' +                    ' data-node="' + d.NODE_NAME_ + '" data-instance="' + d.PROCESS_INSTANCE_ID_ + '" data-app="' + d.URL_ + '" data-task="' + d.ID_ + '">' +                    '<h4>' + d.TASK_NAME_ + '</h4>' +                    '<div class="tag"><span class="name">' + d.PROMOTER_ + '</span>' +                    '<span class="date">' + d.CREATE_DATE_ + '</span></div></div>');                });            }            //else if (listType == "finish") {            //    $(value).each(function (i, d) {            //        itemHtml.push('<div class="list-item no-right">' +            //        '<h4>' + d.TASK_NAME_ + '</h4>' +            //        '<div class="tag"><span class="name">' + d.PROMOTER_ + '</span>' +            //        '<span class="date">' + d.CREATE_DATE_ + '</span></div></div>');            //    });            //}            else if(listType == "my"){                $(value).each(function (i, d) {                    itemHtml.push('<div class="list-item" data-id="' + d.BUSINESS_ID_ + '"' +                    ' data-app="' + d.URL_ + '">' +                    '<h4>' + d.PROCESS_NAME + '</h4>' +                    '<div class="tag"><span class="name">' + d.PROMOTER_ + '</span>' +                    '<span class="date">' + d.CREATE_DATE_ + '</span></div><div class="status">' +                    '<p class="inDes">' + d.STATUS + '</p></div></div>');                });            }else if (listType == "finish"){                $(value).each(function (i, d) {                    itemHtml.push('<div class="list-item" data-id="' + d.BUSINESS_ID_ + '"' +                    ' data-app="' + d.URL_ + '">' +                    '<h4>' + d.TASK_NAME_ + '</h4>' +                    '<div class="tag"><span class="name">' + d.PROMOTER_ + '</span>' +                    '<span class="date">' + d.CREATE_DATE_ + '</span></div><div class="status">' +                    '<p class="inDes">已办</p></div></div>');                });            }        }        if (listDataType == 0) {            $("#taskList").html(itemHtml.join(""));  //插入页面        } else {            $("#taskList").append(itemHtml.join(""));  //跟在页面数据后面        }        $(".list-item").click(function () {            receiveType="";            //if (listType == "wait" || listType == "my"||listType=="finish") {  //绑定点击进入详情，已办不需要点击查看详情                var id = $(this).data("id");                if (id && id!="undefined" && id != "") {                    taskId = $(this).data("task");                    tableType=$(this).data("app");                    setCookie("businessId",id,"1");                    if (listType == "wait") {                        var node = $(this).data("node");                        var instance = $(this).data("instance");                        setCookie("nodeName",node,"1");                        setCookie("taskId",taskId,"1");                        setCookie("instanceId",instance,"1");                    }                    if (tableType && tableType != "undefined"&& tableType != "") {                        listDataType = 0;                              //为了下面方法计算出将来回到列表准确的页码                        var nowListNums = $("#taskList").children(".list-item").size();                        setCookie("pageSize",nowListNums,"1");                        setCookie("listBack","1","1");                        if (listType == "wait" && taskId && taskId != "") {                            //领取                            if ($(this).data("assing") == undefined || $(this).data("assing") == "" || $(this).data("assing") == "null" || $(this).data("assing") == null) {                                receiveType="1";                                $(".modalBg").show();                                $(".receiveModal").fadeIn();                                if (tableType.indexOf("?aljc=Y") > -1) {                                    tableType=tableType.split("?aljc=")[0];                                }                            } else {    //预受理                                receiveType="";                                setCookie("receiveType","","1");                                if (tableType.indexOf("?aljc=Y") > -1) {                                    setCookie("prodict", "1", "1");                                    location.href = tableType.split("?aljc=")[0] + "?app=Y";        // /conference/index                                } else {                                    setCookie("prodict", "0", "1");                                    location.href = tableType + "?app=Y";        // /conference/index                                }                            }                        } else{                            location.href = tableType + "?app=Y";                        }                    } else {                        commons.alertMsg("未知表单");                    }                }            //}        });    },    moreBarStyle: function (count, size) {   //页面加载更多按钮，是否要显示,count:总条数,size：请求的条数        if (parseInt(size)<parseInt(count)) {            $(".pageBar").fadeIn(100);        } else {            $(".pageBar").fadeOut(100);        }    },    getPageBarData: function () {   // 处理列表初次加载、列表刷新、加载更多等情况下的页码和条数，请求参数等信息        var nowNmuber = 0;        var nowSize = 0;        var datas;        if (listBack == "1") { //从详情返回列表,页码：1页，每页条数：之前总共条数            listBack = "0";            nowNmuber = 1;            if(getCookie("pageSize")&&getCookie("pageSize")!=""){                nowSize = getCookie("pageSize");                if (parseInt(nowSize) < 2) {                    nowSize = pageSize                }            }else{                nowSize = pageSize;            }        }else {   //从首页进入列表,或列表刷新            if (listDataType == 0) { //正常首次加载                nowNmuber = pageNumber;                nowSize = pageSize;            } else {   //加载更多                nowNmuber=pageNumber;                nowSize = pageSize;            }            if (parseInt(nowSize) < 2) {                nowSize = pageSize;            }        }        if(selectType.indexOf("flag")>-1&&selectType.indexOf("business")<0){            datas = {"offset": parseInt(nowNmuber)*15-15, "limit": nowSize,"flag": selectType.split("flag")[1]};        }else if(selectType==""){            datas = {"offset": parseInt(nowNmuber)*15-15, "limit": nowSize};        }else if(selectType.indexOf("business")>-1&&selectType.indexOf("flag")<0){            datas = {"offset": parseInt(nowNmuber)*15-15, "limit": nowSize,"business":selectType.split("business")[1]};        }        //else if(selectType.indexOf("business")>-1&&selectType.indexOf("flag")>-1){        //    var business=selectType.split("business")[1];        //    var flag=selectType.split("business")[0];        //        flag=flag.split("flag")[1];        //    datas = {"offset": nowNmuber, "limit": nowSize,"flag":flag,"business":selectType.split("business")[1]};        //}        return datas;    },    getListData: function () {  //待办、已办、跟踪列表数据请求接口        var apiUrl = "";        var datas = lists.getPageBarData();        if (listType == "wait") {            apiUrl = server + "Todo/list?app=Y";        } else if (listType == "finish") {            apiUrl = server + "Todo/done?app=Y";        } else if (listType == "my") {            apiUrl = server + "Todo/my?app=Y";        }        $.ajax({            url: apiUrl,            type: "post",            dataType: "json",            async: false,            cache:false,            data: datas,            //flag： 1内部，2政务网，3预受理  business：1交警 2边防 3治安 4人房 5出入境 6其他            //{"offset": pageNumber, "limit": pageSize, "flag": "1","business":selectType},            success: function (data) {                totalNum = data.total;                lists.moreBarStyle(totalNum, datas.limit);                reloadFinish = 1;                if (totalNum >= 0) {                    lists.listView(data);                }            }, error: function (data) {                if (dataGetCount == 0) {                    dataGetCount = 1;                    commons.logIn();                    lists.getListData();                } else {                    commons.errorToIndex(data);                    commons.alertMsg("数据获取失败");                }            }        });    },    bind: function () {  //页面元素事件绑定        var that = this;        //小标题点击将下面的内容显示隐藏        $(".block").on("click", "h3", function () {            if ($(this).data("status") == "close") {                $(this).data("status", "open").removeClass("off").parent().find(".item").fadeIn();            } else {                $(this).data("status", "close").addClass("off").parent().find(".item").fadeOut();            }        });        $(".back").click(function () {            setCookie("listBack","0","1");            setCookie("selectType","","1");            location.href = indexUrl;        });        $("#loadMore").click(function () { //列表加载更多            listDataType = 1;            var nowNums=$("#taskList").children(".list-item").size();            if (totalNum > nowNums) {                reloadFinish = 0;                pageNumber++;                lists.getListData();            } else {                $("#loadMore").fadeOut();            }        });        $("#listSelect").click(function () { //列表筛选            $(".listTypes").show().animate({'right': 0}, "300");            $(".modalBg").fadeIn(300);            $('html, body').animate({scrollTop: 0}, '100');            $('html,body').addClass('ovfHiden');        });        $(".modalBg").click(function () { //列表筛选是灰色背景            if( receiveType=="") {                $(".listTypes").animate({'right': '-100%'}, "300");                $(".modalBg").fadeOut(100);                $('html,body').removeClass('ovfHiden');                setTimeout(function () {                    $(".listTypes").hide();                }, 100);            }        });        $(".choiceType").click(function(){            selectType = $(this).data("type");            setCookie("selectType",selectType,"1");            pageNumber = 1;            $("#listTitle").text(listTitle + '（' + $(this).text() + '）');            lists.getListData();            $(".listTypes").animate({'right': '-100%'}, "300");            $(".modalBg").fadeOut(100);            $('html,body').removeClass('ovfHiden');            setTimeout(function () {                $(".listTypes").hide();            }, 100);        });        $("#receiveView").click(function(){  //预览            setCookie("receiveType","view","1");            location.href = tableType + "?app=Y";        });        $("#receiveEdit").click(function(){  //领取            setCookie("receiveType","edit","1");            commons.receiveTask(taskId); //领取任务        });    }};$(window).scroll(function () {    if ($(document).scrollTop() >= $(document).height() - $(window).height() - 20) {        if (reloadFinish == 1) {            lists.init();        }    }});